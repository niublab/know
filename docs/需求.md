# Matrix ESS Community 内网部署自动化需求文档

## 1. 项目概述

### 1.1 项目背景
- **上游项目**: Element Server Suite Community Edition (ESS Community)
- **项目地址**: https://github.com/element-hq/ess-helm
- **最新版本**: 25.6.1 (2025年6月10日)
- **许可证**: AGPL-3.0
- **部署方式**: Helm Chart + Kubernetes (K3s)

### 1.2 项目目标
为用户提供一个完全自动化的Matrix视频会议服务部署解决方案，支持50人以下的视频会议需求，具备菜单式交互界面，支持内网部署和外网访问。

## 2. 技术架构分析

### 2.1 ESS Community 核心组件
- **Synapse**: Matrix 服务器核心
- **Matrix Authentication Service (MAS)**: 基于OIDC的下一代认证系统
- **Element Call's Matrix RTC Backend**: 视频会议后端服务
- **Element Web**: Web客户端界面
- **PostgreSQL**: 数据库服务
- **HAProxy**: 负载均衡和路由
- **Well-known delegation**: 联邦和客户端发现

### 2.2 部署架构
```
用户网络拓扑: 路由器 -> 防火墙 -> 服务器(部署ESS)
ISP限制: 封锁80/443端口
网络特点: 动态公网IP + DDNS解析
```

## 3. 详细需求分析

### 3.1 网络环境需求

#### 3.1.1 网络拓扑
- **网络结构**: 路由器 -> 防火墙 -> 服务器
- **ISP限制**: 80/443端口被封锁
- **IP类型**: 动态公网IP
- **DNS解析**: 内网DDNS服务已配置

#### 3.1.2 默认端口配置（可自定义）
- **HTTP端口**: 8080 (替代80)
- **HTTPS端口**: 8443 (替代443)
- **联邦端口**: 8448 (Matrix联邦通信)
- **UDP端口段**: 30152-30352 (WebRTC通信)
- **内部端口**: 30080/30443/30448 (Kubernetes内部)

#### 3.1.3 公网IP获取
- **获取方式**: `dig +short ip.自定义域名 @8.8.8.8` 或 `@1.1.1.1`
- **DDNS服务**: 已配置，自动解析动态IP

### 3.2 域名和证书需求

#### 3.2.1 域名配置
- **域名状态**: 用户已有域名，A记录已创建
- **DNS托管**: Cloudflare
- **子域名结构（可自定义）**:
  - 主域名: `example.com` (Matrix服务器名)
  - Synapse: `matrix`
  - MAS认证: `account`
  - RTC后端: `mrtc`
  - Web客户端: `element`

#### 3.2.2 证书管理
- **证书类型**: 
  - 生产证书 (Let's Encrypt)
  - 测试证书 (Let's Encrypt Staging)
- **验证方式**: DNS-01验证 (Cloudflare)
- **API认证**: Cloudflare API Token
- **邮箱配置**:
  - 证书邮箱: 用于Let's Encrypt通知
  - 管理员邮箱: 可选，用于服务管理

### 3.3 系统环境需求

#### 3.3.1 操作系统
- **系统**: Debian系列
- **硬件**: 满足50人以下视频会议需求
- **存储**: 自定义主目录，默认 `/opt/matrix`

#### 3.3.2 软件依赖
- **Kubernetes**: K3s (轻量级)
- **包管理**: Helm 3.x
- **容器运行时**: containerd (K3s内置)
- **证书管理**: cert-manager

### 3.4 用户体验需求

#### 3.4.1 交互方式
- **部署方式**: 一键脚本部署
- **交互界面**: 菜单式选择
- **用户友好**: 完全小白友好
- **配置保存**: 支持配置文件保存和重用

#### 3.4.2 功能需求
- **自动化部署**: 最小化用户干预
- **配置验证**: 部署前验证配置正确性
- **状态检查**: 部署后自动验证服务状态
- **错误处理**: 友好的错误提示和解决建议

### 3.5 管理和维护需求

#### 3.5.1 用户管理
- **默认注册**: 邀请注册模式 (如与MAS不冲突)
- **初始用户**: 通过MAS CLI创建管理员用户
- **用户认证**: 基于MAS的OIDC认证

#### 3.5.2 维护功能
- **服务重启**: 支持重启所有服务
- **环境清理**: 支持完全清理部署环境
- **配置更新**: 支持配置修改和重新部署
- **日志查看**: 提供日志查看功能

## 4. 技术实施方案

### 4.1 部署脚本架构

#### 4.1.1 脚本结构
```bash
setup.sh (单一脚本文件)
├── 环境检查模块
├── 菜单交互模块 (小白友好，层级最少，0为返回/退出)
├── 配置生成模块 (基于官方values方式)
├── K3s安装模块 (自动安装和配置)
├── cert-manager配置模块 (DNS验证，支持生产/测试证书)
├── ESS部署模块 (基于最新版本，实时验证)
├── 用户创建模块 (32位密码自动生成)
├── 验证测试模块
├── 清理功能模块 (支持部分清理和完全清理)
└── 自我更新模块
```

#### 4.1.2 技术实现原则
- **基于事实**: 严格遵循ESS官方最新版本规范，避免推测
- **错误率最低**: 优先选择稳定可靠的实现方式
- **小白友好**: 自动解决环境问题，最小化用户干预
- **sudo权限**: 脚本以sudo用户运行，自动处理权限问题
- **反复测试**: 支持清理后重新部署，便于测试调试

### 4.2 版本管理和更新策略

#### 4.2.1 ESS版本管理
- **版本策略**: 始终使用最新版本（官方已弃用仓库方式）
- **实时验证**: 脚本运行时检查上游ESS项目最新版本和兼容性
- **Values配置**: 基于官方方式生成，降低错误几率
- **自我更新**: 支持脚本自身的版本更新

#### 4.2.2 依赖组件版本
- **K3s**: 使用稳定版本，自动安装
- **Helm**: 使用最新稳定版本
- **cert-manager**: 使用与ESS兼容的版本

### 4.3 Cloudflare集成

#### 4.3.1 API Token配置
- **权限要求**:
  - Zone:DNS:Edit
  - Zone:Zone:Read
- **作用域**: 特定域名或所有域名
- **存储方式**: Kubernetes Secret
- **安全处理**: 敏感信息加密存储

#### 4.3.2 DNS验证流程
1. 创建Cloudflare API Token Secret
2. 配置cert-manager ClusterIssuer
3. 自动DNS-01验证
4. 证书自动续期
5. 支持生产证书和测试证书（Let's Encrypt Staging）

### 4.4 密码和密钥管理

#### 4.4.1 密码生成规范
- **管理员密码**: 32位长度，包含大小写字母、数字、特殊字符
- **数据库密码**: 自动生成，符合PostgreSQL安全要求
- **JWT密钥**: 自动生成，符合加密强度要求
- **其他密钥**: 根据ESS组件需求自动生成

#### 4.4.2 密钥存储和管理
- **Kubernetes Secrets**: 所有敏感信息存储在K8s Secrets中
- **本地备份**: 关键密码保存到安全的本地文件
- **权限控制**: 严格控制密钥文件的访问权限

### 4.5 清理功能设计

#### 4.5.1 清理级别
- **ESS清理**: 仅清理ESS相关资源，保留K3s和cert-manager
- **应用清理**: 清理ESS和cert-manager，保留K3s集群
- **完全清理**: 清理所有组件，包括K3s集群
- **配置清理**: 清理配置文件和数据目录

#### 4.5.2 清理策略
- **安全确认**: 清理前需要用户确认
- **备份提醒**: 提醒用户备份重要数据
- **渐进清理**: 按依赖关系逐步清理组件
- **状态检查**: 清理后验证清理结果

### 4.6 MAS认证配置

#### 4.6.1 MAS特性
- **认证标准**: OAuth 2.0 / OpenID Connect
- **用户管理**: 本地数据库或外部OIDC
- **状态**: 实验性功能，快速成为标准

#### 4.6.2 配置要点
- **SMTP配置**: 支持用户注册时需要
- **用户创建**: 使用 `mas-cli manage register-user`
- **邮箱验证**: 可选配置

## 5. 部署流程设计

### 5.1 一键部署命令
```bash
bash <(curl -fsSL https://raw.githubusercontent.com/niublab/aiya/main/setup.sh)
```

### 5.2 交互流程
1. **环境检查**: 系统兼容性、网络连通性
2. **基础配置**: 域名、邮箱、目录设置
3. **网络配置**: 端口设置、公网IP获取
4. **证书配置**: 证书类型、Cloudflare API Token
5. **服务配置**: 数据库、存储路径
6. **部署确认**: 配置预览、确认部署
7. **自动部署**: K3s、cert-manager、ESS安装
8. **用户创建**: 创建初始管理员用户
9. **服务验证**: 验证所有服务正常运行
10. **完成总结**: 提供访问信息和后续指导

### 5.3 用户自定义配置

#### 5.3.1 可自定义项目
- **端口配置**: HTTP(8080)、HTTPS(8443)、联邦(8448)、UDP范围 (可自定义)
- **域名配置**: 服务器名、各子域名
- **部署路径**: 默认/opt/matrix，可自定义
- **管理员配置**: 用户名、密码（32位自动生成）
- **邮箱配置**: 
  - 证书申请邮箱（必需）
  - 管理员邮箱（可选，与证书邮箱区分）

#### 5.3.2 配置示例
```yaml
# 端口配置
ports:
  http: 8080
  https: 8443
  federation: 8448
  udp_range: "30152-30250"
  internal:
    http: 30080
    https: 30443
    federation: 30448

# 域名配置
domains:
  server_name: "example.com"
  synapse: "matrix.example.com"
  auth: "account.example.com"
  rtc: "mrtc.example.com"
  web: "chat.example.com"

# 管理员配置
admin:
  username: "admin"
  password: "auto-generated-32-chars"
  email: "admin@example.com"  # 可选

# 证书配置
certificates:
  email: "certs@example.com"  # 必需
  environment: "production"   # 或 "staging"
```

## 6. 安全和合规

### 6.1 证书安全
- **生产证书**: Let's Encrypt正式环境
- **测试证书**: Let's Encrypt Staging环境
- **自动续期**: cert-manager自动管理
- **DNS验证**: 避免HTTP验证的安全风险

### 6.2 网络安全
- **端口限制**: 仅开放必要端口
- **防火墙配置**: 与现有防火墙兼容
- **内网部署**: 服务部署在内网，通过端口映射访问

## 7. 性能和扩展

### 7.1 性能要求
- **用户规模**: 50人以下视频会议
- **硬件要求**: 2 CPU核心，2GB内存（最低）
- **存储要求**: 根据用户数据量动态调整

### 7.2 扩展性
- **水平扩展**: 支持K3s集群扩展
- **组件扩展**: 支持单独扩展各组件
- **存储扩展**: 支持外部数据库和存储

## 8. 错误处理和恢复

### 8.1 常见错误处理
- **网络连接失败**: 提供网络诊断和解决建议
- **域名解析失败**: 验证DNS配置
- **证书申请失败**: 检查API Token和域名配置
- **服务启动失败**: 提供日志查看和重试机制

### 8.2 恢复机制
- **配置备份**: 自动备份配置文件
- **服务重启**: 支持单独重启失败的服务
- **完全重置**: 支持清理环境重新部署

## 9. 文档和支持

### 9.1 用户文档
- **部署指南**: 详细的部署步骤说明
- **配置说明**: 各项配置的含义和建议值
- **故障排除**: 常见问题和解决方案
- **维护指南**: 日常维护和更新指导

### 9.2 技术支持
- **日志收集**: 自动收集关键日志
- **状态检查**: 提供服务状态检查工具
- **配置验证**: 提供配置正确性验证

## 10. 项目交付

### 10.1 交付内容
- **部署脚本**: 完整的自动化部署脚本
- **配置模板**: 各种场景的配置模板
- **文档资料**: 完整的使用和维护文档
- **测试验证**: 部署后的功能验证脚本

### 10.2 验收标准
- **一键部署**: 通过单一命令完成部署
- **菜单交互**: 友好的交互界面
- **功能完整**: 支持50人以下视频会议
- **证书自动**: 自动申请和续期SSL证书
- **维护便捷**: 支持重启和清理功能

## 11. 风险评估

### 11.1 技术风险
- **上游变更**: ESS项目快速迭代可能导致兼容性问题
- **MAS稳定性**: MAS仍为实验性功能，可能存在稳定性问题
- **网络限制**: ISP端口封锁可能影响某些功能

### 11.2 缓解措施
- **版本锁定**: 锁定稳定版本，定期更新
- **功能测试**: 充分测试MAS功能稳定性
- **端口适配**: 灵活配置端口以适应网络限制

---

**文档版本**: 1.0  
**创建日期**: 2025年6月9日  
**最后更新**: 2025年6月9日  
**状态**: 待审核

## 12. 最终确认的技术实现细节

### 12.1 核心实现原则

#### ⚠️ 最重要原则：基于事实，严禁推测
- **一切基于事实**: 严格遵循ESS官方最新版本规范，绝对避免推测和假象
- **官方资料优先**: 不确定的内容必须先查询最新的官方资料和文档
- **实时验证**: 所有实现都要基于当前最新的上游项目规范
- **禁止猜测**: 任何配置、参数、命令都必须有官方依据，不得凭经验推测

#### 其他核心原则
- **单一脚本**: 仅交付setup.sh脚本文件，无需其他配置文件（不包括运行时生成的配置文件）
- **错误率最低**: 优先选择稳定可靠的实现方式，小白友好
- **sudo权限**: 脚本以sudo用户运行，自动解决所有环境问题
- **反复测试**: 支持清理后重新部署，便于测试调试

### 12.2 版本和更新策略
- **ESS版本**: 始终使用最新稳定版本（非测试版或实验性版本，官方已弃用仓库方式）
- **实时验证**: 支持实时验证上游项目版本和兼容性
- **自我更新**: 脚本支持自我更新功能
- **Values配置**: 基于官方方式生成，降低错误几率
- **许可限制**: 不可商用，仅限个人、学习、研究等非商业用途

### 12.3 清理功能设计
- **多级清理**: 支持ESS清理、应用清理、完全清理
- **不影响测试**: 清理范围设计为支持反复部署测试
- **完全清理**: 附加完全清理功能，包括所有组件

### 12.4 密码和安全
- **密码长度**: 管理员密码32位自动生成
- **密钥管理**: 自动生成和管理所有必要密钥
- **DNS验证**: 证书采用DNS验证方式，支持生产和测试证书
- **无自签证书**: 不使用自签证书

### 12.5 用户体验和小白友好设计

#### 小白友好的交互设计
- **菜单设计**: 层级最少，逻辑清晰，0为返回/退出
- **提示信息**: 每个选项都有清晰的说明和示例
- **输入验证**: 实时验证用户输入，提供友好的错误提示
- **默认值**: 为所有配置项提供合理的默认值
- **进度显示**: 显示安装进度和当前步骤
- **错误处理**: 友好的错误信息和解决建议

#### 配置和适配
- **自定义配置**: 端口、域名、路径、用户名、密码、邮箱皆可自定义
- **邮箱区分**: 证书申请邮箱（必需）与管理员邮箱（可选）分离
- **环境适配**: 暂不考虑IPv6，无需错误恢复机制
- **配置保存**: 支持配置保存和重用，避免重复输入

#### 其他可能遗漏的考虑点
- **网络检测**: 自动检测网络连通性和DNS解析
- **端口检测**: 检测端口占用情况
- **备份提醒**: 部署前提醒用户备份重要数据
- **日志记录**: 详细的操作日志，便于问题排查
- **完善的卸载功能**: 提供完整、彻底的卸载和清理功能，支持多级清理选项

## 13. 分阶段开发规划

### 13.1 开发策略
基于"基于事实，严禁推测"的核心原则和项目复杂性，采用分阶段开发策略，确保每个阶段都有可验证的成果。

### 13.2 第一阶段：基础服务功能实现
**目标**: 实现核心基础服务，确保可以正常运行
- **脚本基础框架**: 函数结构、错误处理、日志系统
- **环境准备**: 系统检查、依赖安装、网络验证
- **K3s部署**: 自动安装和配置K3s集群
- **Helm安装**: 安装和配置Helm包管理器
- **cert-manager部署**: 证书管理器安装和基础配置
- **基础菜单**: 简单的操作菜单（安装、卸载、状态检查）
- **许可证声明**: 不可商用限制提醒

### 13.3 第二阶段：ESS核心部署
**目标**: 基于官方资料实现ESS完整部署
- **官方资料查证**: ESS最新稳定版本、配置规范
- **Cloudflare集成**: DNS验证配置和证书申请
- **ESS Helm部署**: 基于官方values的完整部署
- **域名配置**: 多域名配置和DNS记录管理
- **初始用户创建**: MAS用户管理和初始管理员
- **基础验证**: 服务状态检查和连通性测试

### 13.4 第三阶段：用户体验和高级功能
**目标**: 提升用户体验，实现高级功能
- **小白友好菜单**: 层级优化、清晰提示、默认值
- **配置管理**: 自定义配置、保存重用、验证检查
- **密码管理**: 32位密码生成、密钥管理
- **端口检测**: 端口占用检查和冲突处理
- **进度显示**: 安装进度、状态反馈
- **自我更新**: 脚本版本检查和更新

### 13.5 第四阶段：完善和优化
**目标**: 完善功能，确保稳定性
- **多级清理**: ESS清理、应用清理、完全清理
- **错误处理**: 友好错误信息、恢复建议
- **配置备份**: 配置文件备份和恢复
- **文档完善**: 使用说明、故障排除
- **最终测试**: 全流程测试和优化

### 13.6 开发优势
- **更实用**: 第一阶段就能提供基础的K3s+cert-manager环境
- **渐进式**: 每阶段都在前一阶段基础上增强
- **可测试**: 每阶段都有明确的可验证功能
- **基于事实**: 第二阶段重点查证ESS官方规范

---

**文档版本**: 3.0
**创建日期**: 2025年6月9日
**最后更新**: 2025年6月9日
**状态**: 已确认，包含分阶段开发规划
